# 侧边栏

[TOC]

## 前言

### 0.1 连接数据库

- 动态生成侧边栏，完成数据库、集合以及内容的创建。

- 完成数据库检测，测试文件`checkdatabase.py`

  ```python
  '''
  Description: henggao_learning
  version: v1.0.0
  Author: henggao
  Date: 2020-11-13 15:12:07
  LastEditors: henggao
  LastEditTime: 2020-11-13 16:15:02
  '''
  import pymongo
  from pymongo import collation
  from pymongo import collection
  # 连接mongoDB数据库，读取 db 库 table 表中的数据
  client = pymongo.MongoClient("192.168.55.110", 20000)
  # database = "segyfile"
  # db = client[database]
  # collection = "excel_data"
  # db_coll = db[collection]
  # 查询数据库
  database_name = client.list_database_names()
  if '中文数据库' in database_name:
      print('Wow,数据库存在')
  print(database_name) 
  # 查询集合
  database = client['中文数据库']
  collection_name = database.list_collection_names()
  print(collection_name)
  ```

  - [ref](https://www.runoob.com/python3/python-mongodb.html)

### 0.2 集合删选

- 去掉`admin`、`config`数据库

- 去掉`.files`、`.chunks`集合

  - `checkdatabase.py`

  ```python
  '''
  Description: henggao_learning
  version: v1.0.0
  Author: henggao
  Date: 2020-11-13 15:12:07
  LastEditors: henggao
  LastEditTime: 2020-11-16 19:57:48
  '''
  import re
  from re import match
  import pymongo
  from pymongo import collection
  # 连接mongoDB数据库，读取 db 库 table 表中的数据
  client = pymongo.MongoClient("192.168.55.110", 20000)
  # database = "segyfile"
  # db = client[database]
  # collection = "excel_data"
  # db_coll = db[collection]
  # 查询数据库
  databases = client.list_database_names()
  # if '中文数据库' in databases:
  #     print('Wow,数据库存在')
  print(databases)
  # 查询集合
  # database = client['中文数据库']
  # collection_name = database.list_collection_names()
  # print(collection_name)
  # 去掉admin与config数据库
  databases.remove('admin')
  databases.remove('config')
  print(databases)
  print(len(databases))
  database_total = len(databases)  # 获取数据库个数
  
  # print("=========================================")
  list_db = []
  # children = []
  dict_db = {}
  dict_col = {}
  children_id = database_total
  database_id = 0
  for database in databases:
      children = []
      cur_database = client[database]
      collections = cur_database.list_collection_names()
      # 删除.files和.chunks文件
      print("===================当前在的数据库是：" + str(database))
      for collection in collections:
          # print(collection)
          # 删除.chunks集合
          if ('.chunks') in collection:
              collections.remove(collection)
      # print(collections)
  
      for collection in collections:
          # print(collection)
          # 删.files集合
          if ('.files') in collection:
              collections.remove(collection)
      # print(collections)
  
      # 将数据按前端数据要求存放
      for collection in collections:
          children_id += 1
          dict_col = {
              'id': children_id,
              'label': collection
          }
          children.append(dict_col)
      print(children)
      database_id += 1
      dict_db = {
          'id':database_id,
          'label':database,
          'children':children
          }
      list_db.append(dict_db)
  print(list_db)
  
  ```

  

## 一、侧边栏`MenTree`

- 分析一下，哪部分需要动态生成？数据库实现可以绑定好，需要动态生成的是里面的集合，因为我们在实际过程中，会不断地添加数据，即每个集合对应的数据需要在`maincontent`区域中进行增、删、改、查等操作。

### 1.1 前端页面

- Test3.vue

  ```vue
  <template>
    <div class="custom-tree-container">
      <div class="block">
        <p>使用 render-content</p>
        <el-tree
          :data="data"
          show-checkbox
          node-key="id"
          default-expand-all
          :expand-on-click-node="false"
          :render-content="renderContent"
        >
        </el-tree>
      </div>
    </div>
  </template>
  
  <script>
  import axios from "axios";
  import qs from "qs";
  let id = 1000;
  
  export default {
    data() {
      const data = [
        {
          id: 1,
          label: "一级 1",
          children: [
            {
              id: 4,
              label: "二级 1-1",
              children: [
                {
                  id: 9,
                  label: "三级 1-1-1",
                },
                {
                  id: 10,
                  label: "三级 1-1-2",
                },
              ],
            },
          ],
        },
        {
          id: 2,
          label: "一级 2",
          children: [
            {
              id: 5,
              label: "二级 2-1",
            },
            {
              id: 6,
              label: "二级 2-2",
            },
          ],
        },
        {
          id: 3,
          label: "一级 3",
          children: [
            {
              id: 7,
              label: "二级 3-1",
            },
            {
              id: 8,
              label: "二级 3-2",
            },
          ],
        },
      ];
      return {
        data: JSON.parse(JSON.stringify(data)),
        // data: JSON.parse(JSON.stringify(data)),
      };
    },
    created() {
      this.showDataBase();
    },
  
    methods: {
      // 读取数据库信息，返回前端页面展示
      showDataBase() {
        let url = "http://127.0.0.1:8000/load/showdatabase/";
        var temp_list = [];
        axios
          .get(url, {})
          .then((res) => {
            console.log(res.data); //打印后端传过来的数据,string
            console.log(typeof res.data); //打印后端传过来的数据
            this.data = res.data
            // var data_json = res.data.parseJSON();
            // var data_json = JSON.parse(JSON.stringify(res.data));
            // console.log(data_json);
            // console.log(typeof data_json);
            // temp_list.push(res.data);
            // var arr = eval(temp_list);
            // var temp_list = eval("(" + res.data + ")");
            // console.log(arr);
            // console.log(typeof arr);
            // var arrParse = JSON.parse(arr)
            // console.log(typeof arrParse);
            // console.log(arrParse);
            // this.data = temp_list //将数据赋值给data
            // console.log(this.data);
            // console.log(typeof this.data);
          })
          .catch();
      },
      append(data) {
        const newChild = { id: id++, label: "testtest", children: [] };
        if (!data.children) {
          this.$set(data, "children", []);
        }
        data.children.push(newChild);
      },
  
      remove(node, data) {
        const parent = node.parent;
        const children = parent.data.children || parent.data;
        const index = children.findIndex((d) => d.id === data.id);
        children.splice(index, 1);
      },
  
      renderContent(h, { node, data, store }) {
        return (
          <span class="custom-tree-node">
            <span>{node.label}</span>
            <span>
              <el-button
                size="mini"
                type="text"
                on-click={() => this.append(data)}
              >
                <i class="el-icon-plus"></i>
              </el-button>
              <el-button
                size="mini"
                type="text"
                on-click={() => this.remove(node, data)}
              >
                <i class="el-icon-minus"></i>
              </el-button>
            </span>
          </span>
        );
      },
    },
  };
  </script>
  
  <style>
  .custom-tree-node {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
    padding-right: 8px;
  }
  </style>
  ```

  

### 1.2 后端

- views.py

  ```python
  def ShowDataBase(request):
      """
      获取数据库以及集合，在前端实现展示
      """
      if request.method == "GET":
          # 连接mongoDB数据库
          client = pymongo.MongoClient("192.168.55.110", 20000)
          # 查询数据库
          # ['admin', 'config', 'gridfs', 'segyfile', 'testGridfs', 'testdb', '中文数据库']
          databases = client.list_database_names()
          databases.remove('admin')
          databases.remove('config')
          database_total = len(databases)  # 获取数据库个数
  
          # print("=========================================")
          list_db = []
          # children = []
          dict_db = {}
          dict_col = {}
          children_id = database_total
          database_id = 0
          content = {}
          for database in databases:
              children = []
              cur_database = client[database]
              collections = cur_database.list_collection_names()
              # 删除.files和.chunks文件
              print("===================当前在的数据库是：" + str(database))
              for collection in collections:
                  # print(collection)
                  # 删除.chunks集合
                  if ('.chunks') in collection:
                      collections.remove(collection)
              # print(collections)
  
              for collection in collections:
                  # print(collection)
                  # 删.files集合
                  if ('.files') in collection:
                      collections.remove(collection)
              # print(collections)
  
              # 将数据按前端数据要求存放
              for collection in collections:
                  children_id += 1
                  dict_col = {
                      'id': children_id,
                      'label': collection
                  }
                  children.append(dict_col)
              print(children)
              database_id += 1
              dict_db = {
                  'id': database_id,
                  'label': database,
                  'children': children
              }
              list_db.append(dict_db)
              content = dumps(list_db)    #这个地方要用字符串传到前端去
          print(content)
          print(type(content))
          # print(list_db)
          # print(type(list_db))
          return HttpResponse(content, "application/json")
          # return HttpResponse('success')
  ```



### 注意点

- 数据在后端一定要和处理好，再返回前端。这里需要将数据存为为json字符串，再传给前端。

- 如果是传递列表，会出现前端数据之间没有逗号分隔，如下图

  ![](IMG/json字符串问题.png)